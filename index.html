<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Orders System — Firestore (Multi-Items)</title>
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee; --danger:#ef4444; --ok:#22c55e; --line:#1f2937;
      --fs:15.5px;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Cairo,sans-serif}
    body{margin:0;background:radial-gradient(1200px 600px at 100% -10%, #1e293b 10%, transparent 50%),linear-gradient(180deg,#0b1220,#0b1120 60%,#0f172a);color:var(--text);font-size:var(--fs)}
    header{padding:22px 24px;border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center;justify-content:space-between}
    header .brand{font-weight:700;letter-spacing:.2px}
    header small{color:var(--muted)}
    .wrap{max-width:1400px;margin:20px auto;padding:0 16px;display:grid;gap:16px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:16px}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .g4{grid-template-columns:repeat(4,minmax(0,1fr))}
    @media (max-width:1000px){.g4,.g3,.g2{grid-template-columns:1fr}}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,button,textarea{width:100%;background:#0b1220;color:var(--text);border:1px solid #243042;border-radius:14px;padding:12px 14px}
    textarea{min-height:44px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:end}
    .btn{cursor:pointer;border-radius:12px;border:1px solid #2b3b52;background:#0c1728;padding:10px 14px;color:var(--text);font-size:15px}
    .btn:hover{background:#0e2037}
    .btn.danger{border-color:#4b1f25;color:#fecaca;background:#2a1013}
    .btn.ok{border-color:#1f3b2a;background:#112015}
    .btn.ghost{background:#0b1220;border-color:#2b3b52}
    .hint{font-size:12px;color:#a3b0c0}
    .muted{color:var(--muted);font-size:12px}
    table{width:100%;border-collapse:collapse;overflow:auto;border-radius:12px}
    thead th{font-size:14px;color:#9fb1c6;background:#0b1322;position:sticky;top:0;padding:14px 12px}
    th,td{border-bottom:1px solid #1f2b3d;padding:14px 12px;text-align:center;vertical-align:middle;font-size:15px}
    .pill{border:1px solid #334155;padding:.15rem .5rem;border-radius:999px;color:#e2e8f0;font-size:12px;display:inline-block}
    .flex{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .items-head{display:flex;align-items:center;justify-content:space-between;margin:8px 0}
    .scroll-x{overflow:auto}
    .totals-bar{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
    .chip{padding:.45rem .7rem;border:1px solid #324055;border-radius:10px;font-size:13.5px}
    .dangerText{color:#ef4444}
    .okText{color:#22c55e}

    /* Wider inputs inside items table */
    #itemsTbl tbody td > input,
    #itemsTbl tbody td > select{ min-width:110px }
    #itemsTbl .it-name{ min-width:180px }
    #itemsTbl .it-note{ min-width:160px }
    #itemsTbl .it-pcsd{ min-width:140px }
    #itemsTbl .it-pcs,
    #itemsTbl .it-org,
    #itemsTbl .it-sell,
    #itemsTbl .it-pcsUsd,
    #itemsTbl .it-tOrgCny,
    #itemsTbl .it-tOrgUsd,
    #itemsTbl .it-tSellCny,
    #itemsTbl .it-tSellUsd,
    #itemsTbl .it-perVal{ min-width:110px; text-align:center }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="brand">Orders System</div>
      <small>Firestore only — Multi items per order</small>
    </div>
  </header>

  <main class="wrap">
    <!-- Order Form -->
    <section class="card" id="formCard">
      <h3 style="margin:0 0 10px">Order Header</h3>
      <div class="grid g4">
        <div><label>Order Date</label><input id="orderDate" type="date"></div>
        <div><label>Order No</label><input id="orderNo" placeholder="ORD-001"></div>
        <div><label>Customer</label><input id="customer" placeholder="Customer name"></div>
        <div>
          <label>Loading Type</label>
          <select id="loadingType">
            <option value="">Select...</option>
            <option>Sea</option>
            <option>Air</option>
            <option>Express</option>
            <option>Other</option>
          </select>
        </div>

        <div><label>Link / Market (WeChat)</label><input id="link" placeholder="https://..."></div>
        <div><label>Buy Item Date</label><input id="buyItemDate" type="date"></div>
        <div><label>Track Number</label><input id="trackNo" placeholder="YT..."></div>
        <div><label>Arrived China Warehouse (Date & Time)</label><input id="arrivedChina" type="datetime-local"></div>

        <div>
          <label>Items & PCS Correct?</label>
          <select id="isCorrect">
            <option value="yes">Yes</option><option value="no">No</option>
          </select>
        </div>
        <div><label>If NOT correct — note</label><input id="ifNotCorrectNote" placeholder="Short issue notes"></div>
        <div><label>Warehouse Notes</label><input id="warehouseNotes"></div>
        <div><label>Final Notes</label><input id="finalNotes"></div>

        <div><label>Money Refunded ($)</label><input id="moneyRefunded" type="number" step="0.01" value="0"></div>
        <div><label>Exchange Rate (CNY→USD)</label><input id="exchangeRate" type="number" step="0.0001" value="7.20"></div>
        <div><label>CBM Price ($)</label><input id="cbmPrice" type="number" step="0.01" value="0"></div>
        <div><label>CBM</label><input id="cbm" type="number" step="0.001" value="0"></div>

        <div><label>Total Order CBM Price ($)</label><input id="totalOrderCbmPrice" type="number" step="0.01" value="0"></div>
        <div><label>Box No</label><input id="boxNo" placeholder="#"></div>
        <div>
          <label>Arrived Iraq Warehouse?</label>
          <select id="arrivedIraq">
            <option value="no" selected>No</option><option value="yes">Yes</option>
          </select>
        </div>
        <div><label>Arrived Iraq — Date & Time</label><input id="arrivedIraqAt" type="datetime-local"></div>

        <div><label>Original CBM Price ($)</label><input id="originalCbmPrice" type="number" step="0.01" value="0"></div>
        <div><label>Original CBM</label><input id="originalCbm" type="number" step="0.001" value="0"></div>
        <div><label>Total Original CBM Price ($)</label><input id="totalOriginalCbmPrice" type="number" step="0.01" value="0"></div>
        <div>
          <label>Who Paid for Item</label>
          <select id="whoPaidForItem">
            <option value="">Select...</option>
            <option>Customer</option>
            <option>Us</option>
            <option>Shared</option>
            <option>Other</option>
          </select>
        </div>

        <div><label>Total Order Pay ($)</label><input id="totalOrderPay" type="number" step="0.01" value="0"></div>
        <div><label>Item Target ($)</label><input id="itemTarget" type="number" step="0.01" value="0"></div>
        <div><label>CBM Target ($)</label><input id="cbmTarget" type="number" step="0.01" value="0"></div>
        <div><label>Commission Target ($)</label><input id="commissionTarget" type="number" step="0.01" value="0"></div>

        <div><label>Total Target ($)</label><input id="totalTarget" type="number" step="0.01" value="0"></div>
        <div><label>How Much Customer Paid ($)</label><input id="howMuchPaid" type="number" step="0.01" value="0"></div>
        <div><label>How Much Customer Requires ($)</label><input id="howMuchRequire" type="number" step="0.01" value="0"></div>
        <div>
          <label>Customer Received Goods?</label>
          <select id="customerReceived">
            <option value="no" selected>No</option><option value="yes">Yes</option>
          </select>
        </div>

        <div><label>Header Photo (optional)</label><input id="photo" type="file" accept="image/*"></div>
        <div><label>Warehouse Photo (optional)</label><input id="warehousePhoto" type="file" accept="image/*"></div>
      </div>

      <!-- Items -->
      <div class="items-head">
        <h3 style="margin:12px 0">Items</h3>
        <button class="btn" id="btnAddItem">➕ Add Item</button>
      </div>
      <div class="scroll-x">
        <table id="itemsTbl">
          <thead>
            <tr>
              <th>Item</th>
              <th>Item Notes</th>
              <th>PCS Details</th>
              <th>Total PCS</th>
              <th>Photo</th>
              <th>Org Price (CNY)</th>
              <th>Sell Price / PC (CNY)</th>
              <th>Sell Price / PC ($) (Auto)</th>
              <th>Total Org (CNY)</th>
              <th>Total Org ($)</th>
              <th>Total Sell (CNY)</th>
              <th>Total Sell ($)</th>
              <th>Per. Type</th>
              <th>Percentage / Fix</th>
              <th>Total Sell + Commission ($)</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="totals-bar" id="calcBar"></div>

      <div class="row" style="margin-top:12px">
        <button id="btnSave" class="btn ok">Save Order</button>
        <div class="flex">
          <button id="btnReset" class="btn ghost">Reset</button>
        </div>
      </div>
      <div id="calcHint" class="hint" style="margin-top:8px"></div>
    </section>

    <!-- Orders List -->
    <section class="card">
      <div class="flex" style="justify-content:space-between;align-items:center">
        <div class="flex">
          <label>Search</label>
          <input id="q" placeholder="Customer / Order No / Item" style="min-width:260px">
        </div>
      </div>
      <div style="overflow:auto;margin-top:10px">
        <table id="tbl">
          <thead>
            <tr>
              <th>Date</th>
              <th>No</th>
              <th>Customer</th>
              <th>#Items</th>
              <th>Total Org $</th>
              <th>Total Sell $</th>
              <th>Commission $</th>
              <th>Profit $</th>
              <th>Correct</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <script type="module">
    // 1) Firebase Config (replace from your Console)
    const firebaseConfig = {
      apiKey: "PASTE_YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      messagingSenderId: "",
      appId: "",
    };

    // 2) SDK imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // 3) Init
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // Helpers
    const fmt = n => new Intl.NumberFormat('en-US',{maximumFractionDigits:2}).format(n||0);
    const el  = id => document.getElementById(id);
    const money = n => (Number.isFinite(+n) ? +n : 0);

    // Image -> Base64 (compressed JPEG)
    async function fileToCompressedBase64(file, maxWidth = 900, quality = 0.75){
      if(!file) return null;
      const img = await new Promise((res,rej)=>{
        const u = URL.createObjectURL(file);
        const i = new Image();
        i.onload=()=>res(i); i.onerror=rej; i.src=u;
      });
      const scale = Math.min(1, maxWidth / img.width);
      const canvas = document.createElement('canvas');
      canvas.width = Math.round(img.width*scale);
      canvas.height= Math.round(img.height*scale);
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img,0,0,canvas.width,canvas.height);
      const blob = await new Promise(r=> canvas.toBlob(r,'image/jpeg',quality));
      const ab = await blob.arrayBuffer();
      const base64 = btoa(String.fromCharCode(...new Uint8Array(ab)));
      return {base64, mime:'image/jpeg', w:canvas.width, h:canvas.height, bytes: blob.size};
    }

    // Header fields
    const orderDate=el('orderDate'), orderNo=el('orderNo'), customer=el('customer'), loadingType=el('loadingType');
    const link=el('link'), buyItemDate=el('buyItemDate'), trackNo=el('trackNo'), arrivedChina=el('arrivedChina');
    const isCorrect=el('isCorrect'), ifNotCorrectNote=el('ifNotCorrectNote'), warehouseNotes=el('warehouseNotes'), finalNotes=el('finalNotes');
    const moneyRefunded=el('moneyRefunded'), exchangeRate=el('exchangeRate'), cbmPrice=el('cbmPrice'), cbm=el('cbm');
    const totalOrderCbmPrice=el('totalOrderCbmPrice'), boxNo=el('boxNo'), arrivedIraq=el('arrivedIraq'), arrivedIraqAt=el('arrivedIraqAt');
    const originalCbmPrice=el('originalCbmPrice'), originalCbm=el('originalCbm'), totalOriginalCbmPrice=el('totalOriginalCbmPrice'), whoPaidForItem=el('whoPaidForItem');
    const totalOrderPay=el('totalOrderPay'), itemTarget=el('itemTarget'), cbmTarget=el('cbmTarget'), commissionTarget=el('commissionTarget');
    const totalTarget=el('totalTarget'), howMuchPaid=el('howMuchPaid'), howMuchRequire=el('howMuchRequire'), customerReceived=el('customerReceived');
    const photo=el('photo'), warehousePhoto=el('warehousePhoto');

    const itemsTbl = el('itemsTbl').querySelector('tbody');
    const btnAddItem=el('btnAddItem'), btnSave=el('btnSave'), btnReset=el('btnReset');
    const calcBar=el('calcBar'), calcHint=el('calcHint');
    const qInput = el('q'); const listBody = el('tbl').querySelector('tbody');

    // Items dynamic row
    function makeItemRow(data={}){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <select class="it-name">
            <option value="">Custom...</option>
            <option>Clothes</option>
            <option>Shoes</option>
            <option>Electronics</option>
            <option>Cosmetics</option>
            <option>Accessories</option>
          </select>
          <input class="it-name-free" placeholder="If 'Custom...', type here" style="margin-top:6px">
        </td>
        <td><input placeholder="Notes" class="it-note"></td>
        <td><input placeholder="e.g., 10×M" class="it-pcsd"></td>
        <td><input type="number" step="1" value="0" class="it-pcs"></td>
        <td><input type="file" accept="image/*" class="it-photo"></td>
        <td><input type="number" step="0.01" value="0" class="it-org"></td>
        <td><input type="number" step="0.01" value="0" class="it-sell"></td>
        <td><input type="number" step="0.0001" value="0" class="it-pcsUsd" disabled></td>
        <td><input type="number" step="0.01" value="0" class="it-tOrgCny" disabled></td>
        <td><input type="number" step="0.01" value="0" class="it-tOrgUsd" disabled></td>
        <td><input type="number" step="0.01" value="0" class="it-tSellCny" disabled></td>
        <td><input type="number" step="0.01" value="0" class="it-tSellUsd" disabled></td>
        <td>
          <select class="it-perType">
            <option value="%">Percent %</option>
            <option value="fix">Fixed ($)</option>
          </select>
        </td>
        <td><input type="number" step="0.01" value="0" class="it-perVal"></td>
        <td><input type="number" step="0.01" value="0" class="it-totalWithCom" disabled></td>
        <td><button class="btn danger it-del">Delete</button></td>
      `;

      // Init values
      tr.querySelector('.it-name-free').value = '';
      tr.querySelector('.it-note').value = data.itemNotes||'';
      tr.querySelector('.it-pcsd').value = data.pcsDetails||'';
      tr.querySelector('.it-pcs').value = data.totalPcs||0;
      tr.querySelector('.it-org').value = data.orgPriceCny||0;
      tr.querySelector('.it-sell').value= data.pcsPriceCny||0;
      tr.querySelector('.it-perType').value = data.perType||'%';
      tr.querySelector('.it-perVal').value  = data.percentage||0;

      function currentItemName(){
        const sel = tr.querySelector('.it-name').value;
        const free = tr.querySelector('.it-name-free').value.trim();
        return sel || free;
      }

      function recalc(){
        const pcs = +tr.querySelector('.it-pcs').value||0;
        const org = +tr.querySelector('.it-org').value||0;
        const sell= +tr.querySelector('.it-sell').value||0;
        const rate= +exchangeRate.value||1;

        const pcsUsd = rate ? sell / rate : 0;
        const tOrgCny = pcs*org;
        const tOrgUsd = rate ? tOrgCny / rate : 0;
        const tSellCny = pcs*sell;
        const tSellUsd = rate ? tSellCny / rate : 0;

        tr.querySelector('.it-pcsUsd').value  = pcsUsd.toFixed(2);
        tr.querySelector('.it-tOrgCny').value = tOrgCny.toFixed(2);
        tr.querySelector('.it-tOrgUsd').value = tOrgUsd.toFixed(2);
        tr.querySelector('.it-tSellCny').value= tSellCny.toFixed(2);
        tr.querySelector('.it-tSellUsd').value= tSellUsd.toFixed(2);

        const perType = tr.querySelector('.it-perType').value;
        const perVal  = +tr.querySelector('.it-perVal').value||0;
        const commission = perType==='%' ? (tSellUsd*perVal/100) : perVal;
        tr.querySelector('.it-totalWithCom').value = (tSellUsd + commission).toFixed(2);

        recomputeTotals();
      }

      tr.addEventListener('input', (e)=>{
        if(['.it-pcs','.it-org','.it-sell','.it-perVal'].some(cls=> e.target.matches(cls))) recalc();
      });
      tr.querySelector('.it-name').addEventListener('change', recalc);
      tr.querySelector('.it-name-free').addEventListener('input', recalc);
      exchangeRate.addEventListener('input', recalc);

      tr.querySelector('.it-del').onclick = ()=> { tr.remove(); recomputeTotals(); };

      itemsTbl.appendChild(tr);
      recalc();
    }

    btnAddItem.onclick = ()=> makeItemRow();

    // Totals
    function recomputeTotals(){
      let totalOrgUsd=0, totalSellUsd=0, totalCommission=0;
      itemsTbl.querySelectorAll('tr').forEach(tr=>{
        totalOrgUsd   += +tr.querySelector('.it-tOrgUsd').value || 0;
        totalSellUsd  += +tr.querySelector('.it-tSellUsd').value || 0;
        const perType = tr.querySelector('.it-perType').value;
        const perVal  = +tr.querySelector('.it-perVal').value||0;
        const tSell   = +tr.querySelector('.it-tSellUsd').value||0;
        totalCommission += perType==='%' ? (tSell*perVal/100) : perVal;
      });

      const profitUsd = (totalSellUsd - totalOrgUsd) + totalCommission - money(moneyRefunded.value||0);
      const cbmCost   = money(cbmPrice.value)*money(cbm.value);
      const orderCbm  = money(totalOrderCbmPrice.value||0);
      const finalProfit = profitUsd - cbmCost - orderCbm;

      calcBar.innerHTML = `
        <span class="chip">Total Org $: <b>${fmt(totalOrgUsd)}</b></span>
        <span class="chip">Total Sell $: <b>${fmt(totalSellUsd)}</b></span>
        <span class="chip">Commission $: <b>${fmt(totalCommission)}</b></span>
        <span class="chip">Shipping (cbm×price): <b>${fmt(cbmCost)}</b></span>
        <span class="chip">Extra Shipping: <b>${fmt(orderCbm)}</b></span>
        <span class="chip">Refunded: <b>${fmt(moneyRefunded.value)}</b></span>
        <span class="chip ${finalProfit>=0?'okText':'dangerText'}">Final Profit $: <b>${fmt(finalProfit)}</b></span>
      `;
      calcHint.textContent = 'Values auto-calculated from items table + shipping/refund inputs.';
    }
    ['input','change'].forEach(ev=>{
      [moneyRefunded, cbmPrice, cbm, totalOrderCbmPrice].forEach(x=> x.addEventListener(ev, recomputeTotals));
    });

    btnReset.onclick = ()=>{
      document.querySelectorAll('#formCard input, #formCard select, #formCard textarea').forEach(i=>{
        if(i.type==='file') i.value = '';
        else if(i.id==='exchangeRate') i.value = 7.20;
        else if(i.tagName==='SELECT') i.selectedIndex = 0;
        else i.value = '';
      });
      itemsTbl.innerHTML = '';
      recomputeTotals();
    };

    async function getItemsPayload(){
      const items=[];
      for(const tr of Array.from(itemsTbl.querySelectorAll('tr'))){
        const selName = tr.querySelector('.it-name').value;
        const free    = tr.querySelector('.it-name-free').value.trim();
        const name    = selName || free;
        if(!name) continue;

        const pcs = +tr.querySelector('.it-pcs').value||0;
        const org = +tr.querySelector('.it-org').value||0;
        const sell= +tr.querySelector('.it-sell').value||0;
        const perType = tr.querySelector('.it-perType').value;
        const perVal  = +tr.querySelector('.it-perVal').value||0;

        const rate = +exchangeRate.value||1;
        const pcsUsd = rate? sell/rate : 0;
        const tOrgCny = pcs*org;
        const tOrgUsd = rate? tOrgCny/rate : 0;
        const tSellCny= pcs*sell;
        const tSellUsd= rate? tSellCny/rate : 0;
        const commission = perType==='%' ? (tSellUsd*perVal/100) : perVal;
        const totalWithCommission = tSellUsd + commission;

        const f = tr.querySelector('.it-photo').files[0];
        const photoB = await fileToCompressedBase64(f);
        if(photoB && photoB.bytes > 950*1024) throw new Error('Item photo too large after compression.');

        items.push({
          item:name,
          itemNotes: tr.querySelector('.it-note').value.trim(),
          pcsDetails: tr.querySelector('.it-pcsd').value.trim(),
          totalPcs: pcs,
          orgPriceCny: org,
          pcsPriceCny: sell,
          pcsPriceUsd: pcsUsd,
          totals:{ tOrgCny, tOrgUsd, tSellCny, tSellUsd, totalWithCommission, commission },
          perType, percentage: perVal,
          photoB64: photoB?photoB.base64:null,
          photoMeta: photoB?{mime:photoB.mime,w:photoB.w,h:photoB.h,bytes:photoB.bytes}:null
        });
      }
      return items;
    }

    // Save
    btnSave.onclick = async ()=>{
      try{
        btnSave.disabled = true; btnSave.textContent='Saving...';

        const items = await getItemsPayload();
        if(!orderNo.value.trim()) throw new Error('Enter Order No');
        if(items.length===0) throw new Error('Add at least one item');

        const photoB = await fileToCompressedBase64(photo.files[0]);
        const whB    = await fileToCompressedBase64(warehousePhoto.files[0]);
        if(photoB && photoB.bytes>950*1024) throw new Error('Header photo too large.');
        if(whB && whB.bytes>950*1024) throw new Error('Warehouse photo too large.');

        const totOrgUsd = items.reduce((s,x)=> s+(x.totals?.tOrgUsd||0),0);
        const totSellUsd= items.reduce((s,x)=> s+(x.totals?.tSellUsd||0),0);
        const totComm   = items.reduce((s,x)=> s+(x.totals?.commission||0),0);
        const profit    = (totSellUsd - totOrgUsd) + totComm - money(moneyRefunded.value||0);

        const payload = {
          orderDate: orderDate.value||null,
          orderNo: orderNo.value.trim(),
          customer: customer.value.trim(),
          loadingType: loadingType.value.trim(),
          link: link.value.trim(),
          buyItemDate: buyItemDate.value||null,
          trackNo: trackNo.value.trim(),
          arrivedChina: arrivedChina.value||null,
          isCorrect: isCorrect.value==='yes',
          ifNotCorrectNote: ifNotCorrectNote.value.trim(),
          warehouseNotes: warehouseNotes.value.trim(),
          finalNotes: finalNotes.value.trim(),
          moneyRefunded: +moneyRefunded.value||0,
          exchangeRate: +exchangeRate.value||0,
          cbmPrice: +cbmPrice.value||0,
          cbm: +cbm.value||0,
          totalOrderCbmPrice: +totalOrderCbmPrice.value||0,
          boxNo: boxNo.value.trim(),
          arrivedIraq: arrivedIraq.value==='yes',
          arrivedIraqAt: arrivedIraqAt.value||null,
          originalCbmPrice: +originalCbmPrice.value||0,
          originalCbm: +originalCbm.value||0,
          totalOriginalCbmPrice: +totalOriginalCbmPrice.value||0,
          whoPaidForItem: whoPaidForItem.value.trim(),
          totalOrderPay: +totalOrderPay.value||0,
          itemTarget: +itemTarget.value||0,
          cbmTarget: +cbmTarget.value||0,
          commissionTarget: +commissionTarget.value||0,
          totalTarget: +totalTarget.value||0,
          howMuchPaid: +howMuchPaid.value||0,
          howMuchRequire: +howMuchRequire.value||0,
          customerReceived: customerReceived.value==='yes',
          headerPhotoB64: photoB?photoB.base64:null,
          headerPhotoMeta: photoB?{mime:photoB.mime,w:photoB.w,h:photoB.h,bytes:photoB.bytes}:null,
          warehousePhotoB64: whB?whB.base64:null,
          warehousePhotoMeta: whB?{mime:whB.mime,w:whB.w,h:whB.h,bytes:whB.bytes}:null,
          items,
          totals:{ totalOrgUsd: totOrgUsd, totalSellUsd: totSellUsd, totalCommission: totComm, profitUsd: profit },
          createdAt: serverTimestamp()
        };

        await addDoc(collection(db,'orders'), payload);
        btnSave.textContent = 'Saved ✅';
        setTimeout(()=>{ btnSave.textContent='Save Order'; btnSave.disabled=false; },800);
        btnReset.click();
      }catch(err){
        alert('Save failed: '+(err.message||err.code));
        btnSave.disabled=false; btnSave.textContent='Save Order';
      }
    };

    // List
    let rowsCache=[];
    function renderList(list){
      const q = (qInput.value||'').toLowerCase();
      const filtered = list.filter(r =>
        !q || (r.customer?.toLowerCase().includes(q)) || (r.orderNo?.toLowerCase().includes(q)) ||
        (r.items||[]).some(it=> it.item?.toLowerCase().includes(q))
      );
      listBody.innerHTML='';
      for(const r of filtered){
        const tr=document.createElement('tr');
        const profit = (r.totals?.profitUsd||0) - (r.cbmPrice||0)*(r.cbm||0) - (r.totalOrderCbmPrice||0);
        const profitColor = profit>=0? 'style="color:#22c55e"':'style="color:#ef4444"';
        tr.innerHTML = `
          <td>${r.orderDate||'-'}</td>
          <td>${r.orderNo||'-'}</td>
          <td>${r.customer||'-'}</td>
          <td>${r.items?.length||0}</td>
          <td>$${fmt(r.totals?.totalOrgUsd||0)}</td>
          <td>$${fmt(r.totals?.totalSellUsd||0)}</td>
          <td>$${fmt(r.totals?.totalCommission||0)}</td>
          <td ${profitColor}>$${fmt(profit)}</td>
          <td>${r.isCorrect?'<span class="pill">Yes</span>':'<span class="pill" style="color:#fecaca">No</span>'}</td>
          <td>
            <div class="flex">
              <button class="btn" data-view="${r._id}">View</button>
              <button class="btn" data-edit="${r._id}">Edit</button>
              <button class="btn danger" data-del="${r._id}">Delete</button>
            </div>
          </td>
        `;
        listBody.appendChild(tr);
      }
    }

    onSnapshot(query(collection(db,'orders'), orderBy('createdAt','desc')), (snap)=>{
      rowsCache = snap.docs.map(d=>({_id:d.id, ...d.data()}));
      renderList(rowsCache);
    });
    qInput.addEventListener('input', ()=> renderList(rowsCache));

    listBody.addEventListener('click', async (ev)=>{
      const id = ev.target.getAttribute('data-del') || ev.target.getAttribute('data-edit') || ev.target.getAttribute('data-view');
      if(!id) return;
      const dref = doc(db,'orders',id);
      const row = rowsCache.find(x=> x._id===id);
      if(!row) return;

      if(ev.target.hasAttribute('data-del')){
        if(confirm('Delete this order?')) await deleteDoc(dref);
        return;
      }

      if(ev.target.hasAttribute('data-view')){
        const details = (row.items||[]).map((it,i)=>`${i+1}) ${it.item} — PCS:${it.totalPcs} — $${fmt(it.totals?.tSellUsd||0)}`).join('\n');
        alert(`Order ${row.orderNo}\nCustomer: ${row.customer}\nItems:\n${details||'-'}\n\nNotes: ${row.finalNotes||'-'}`);
        return;
      }

      // Load to edit
      btnReset.click();
      orderDate.value = row.orderDate||'';
      orderNo.value   = row.orderNo||'';
      customer.value  = row.customer||'';
      loadingType.value=row.loadingType||'';
      link.value      = row.link||'';
      buyItemDate.value=row.buyItemDate||'';
      trackNo.value   = row.trackNo||'';
      arrivedChina.value=row.arrivedChina||'';
      isCorrect.value = row.isCorrect?'yes':'no';
      ifNotCorrectNote.value=row.ifNotCorrectNote||'';
      warehouseNotes.value=row.warehouseNotes||'';
      finalNotes.value=row.finalNotes||'';
      moneyRefunded.value=row.moneyRefunded||0;
      exchangeRate.value=row.exchangeRate||7.2;
      cbmPrice.value=row.cbmPrice||0;
      cbm.value=row.cbm||0;
      totalOrderCbmPrice.value=row.totalOrderCbmPrice||0;
      boxNo.value=row.boxNo||'';
      arrivedIraq.value=row.arrivedIraq?'yes':'no';
      arrivedIraqAt.value=row.arrivedIraqAt||'';
      originalCbmPrice.value=row.originalCbmPrice||0;
      originalCbm.value=row.originalCbm||0;
      totalOriginalCbmPrice.value=row.totalOriginalCbmPrice||0;
      whoPaidForItem.value=row.whoPaidForItem||'';
      totalOrderPay.value=row.totalOrderPay||0;
      itemTarget.value=row.itemTarget||0;
      cbmTarget.value=row.cbmTarget||0;
      commissionTarget.value=row.commissionTarget||0;
      totalTarget.value=row.totalTarget||0;
      howMuchPaid.value=row.howMuchPaid||0;
      howMuchRequire.value=row.howMuchRequire||0;
      customerReceived.value=row.customerReceived?'yes':'no';

      (row.items||[]).forEach(it=> makeItemRow(it));
      recomputeTotals();

      // Switch save -> update
      btnSave.textContent = 'Update Order';
      const originalHandler = btnSave.onclick;
      btnSave.onclick = async ()=>{
        try{
          btnSave.disabled=true; btnSave.textContent='Updating...';
          const items = await getItemsPayload();

          const totOrgUsd = items.reduce((s,x)=> s+(x.totals?.tOrgUsd||0),0);
          const totSellUsd= items.reduce((s,x)=> s+(x.totals?.tSellUsd||0),0);
          const totComm   = items.reduce((s,x)=> s+(x.totals?.commission||0),0);
          const profit    = (totSellUsd - totOrgUsd) + totComm - money(moneyRefunded.value||0);

          const newHeaderPhoto = photo.files[0] ? await fileToCompressedBase64(photo.files[0]) : null;
          const newWh = warehousePhoto.files[0] ? await fileToCompressedBase64(warehousePhoto.files[0]) : null;
          if(newHeaderPhoto && newHeaderPhoto.bytes>950*1024) throw new Error('Header photo too large.');
          if(newWh && newWh.bytes>950*1024) throw new Error('Warehouse photo too large.');

          await updateDoc(dref, {
            orderDate: orderDate.value||null,
            orderNo: orderNo.value.trim(),
            customer: customer.value.trim(),
            loadingType: loadingType.value.trim(),
            link: link.value.trim(),
            buyItemDate: buyItemDate.value||null,
            trackNo: trackNo.value.trim(),
            arrivedChina: arrivedChina.value||null,
            isCorrect: isCorrect.value==='yes',
            ifNotCorrectNote: ifNotCorrectNote.value.trim(),
            warehouseNotes: warehouseNotes.value.trim(),
            finalNotes: finalNotes.value.trim(),
            moneyRefunded: +moneyRefunded.value||0,
            exchangeRate: +exchangeRate.value||0,
            cbmPrice: +cbmPrice.value||0,
            cbm: +cbm.value||0,
            totalOrderCbmPrice: +totalOrderCbmPrice.value||0,
            boxNo: boxNo.value.trim(),
            arrivedIraq: arrivedIraq.value==='yes',
            arrivedIraqAt: arrivedIraqAt.value||null,
            originalCbmPrice: +originalCbmPrice.value||0,
            originalCbm: +originalCbm.value||0,
            totalOriginalCbmPrice: +totalOriginalCbmPrice.value||0,
            whoPaidForItem: whoPaidForItem.value.trim(),
            totalOrderPay: +totalOrderPay.value||0,
            itemTarget: +itemTarget.value||0,
            cbmTarget: +cbmTarget.value||0,
            commissionTarget: +commissionTarget.value||0,
            totalTarget: +totalTarget.value||0,
            howMuchPaid: +howMuchPaid.value||0,
            howMuchRequire: +howMuchRequire.value||0,
            customerReceived: customerReceived.value==='yes',
            headerPhotoB64: newHeaderPhoto ? newHeaderPhoto.base64 : (row.headerPhotoB64 ?? null),
            headerPhotoMeta: newHeaderPhoto ? {mime:newHeaderPhoto.mime,w:newHeaderPhoto.w,h:newHeaderPhoto.h,bytes:newHeaderPhoto.bytes} : (row.headerPhotoMeta ?? null),
            warehousePhotoB64: newWh ? newWh.base64 : (row.warehousePhotoB64 ?? null),
            warehousePhotoMeta: newWh ? {mime:newWh.mime,w:newWh.w,h:newWh.h,bytes:newWh.bytes} : (row.warehousePhotoMeta ?? null),
            items,
            totals:{ totalOrgUsd: totOrgUsd, totalSellUsd: totSellUsd, totalCommission: totComm, profitUsd: profit },
          });

          alert('Updated ✅');
          btnSave.disabled=false; btnSave.textContent='Save Order';
          btnSave.onclick = originalHandler;
          btnReset.click();
        }catch(e){
          alert('Update failed: '+(e.message||e.code));
          btnSave.disabled=false; btnSave.textContent='Update Order';
        }
      };
    });

  </script>
</body>
</html>
